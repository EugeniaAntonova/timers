<section data-request-id="13" class="section game sevens"
    style="--game-color: rgb(78 157 38); --background: url('https://static.sz.kz/landings/visualizer/777.svg')"
    id="thsev">
    <img src="<#SelfURL>/picture?file=108" alt="777" class="game-logo">
    <div class="section-content">
        <h2 class="visually-hidden">
            777
        </h2>
        <div class="timer js-ths" data-timer="true" data-postfix="777">
            <div class="timer__title">
                До тиража:
            </div>
            <div class="timer__body timer__body_desk-slider">
                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider days-777">00</span>
                    <span class="timer__label timer__label_desk-slider">д.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider hours-777">00</span>
                    <span class="timer__label timer__label_desk-slider">ч.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider minutes-777">00</span>
                    <span class="timer__label timer__label_desk-slider">м.</span>
                </div>
            </div>
        </div>
        <div class="actions">
            <a href="/gamedemo?gameid=1081" class="action part">Участвовать</a>
            <a href="/resultsGame?gAlias=bet_sz_777" class="action archive">Архив</a>
        </div>
        <div class="result">
            <h3 class="result-title">
                Результат:
            </h3>
            <div class="result-string js-result await">
                <div class="loader-element">
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                </div>
            </div>
        </div>
    </div>
</section>
<section data-request-id="1" class="section game 820"
    style="--game-color: #810baa; --background: url('https://static.sz.kz/landings/visualizer/820.svg')" id="eghtw">
    <img src="<#SelfURL>/picture?file=436" alt="8/20" class="game-logo">
    <div class="section-content">
        <h2 class="visually-hidden">
            8/20
        </h2>
        <div class="timer js-eghtw" data-timer="true" data-postfix="820">
            <div class="timer__title">
                До тиража:
            </div>
            <div class="timer__body timer__body_desk-slider">
                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider days-820">00</span>
                    <span class="timer__label timer__label_desk-slider">д.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider hours-820">00</span>
                    <span class="timer__label timer__label_desk-slider">ч.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider minutes-820">00</span>
                    <span class="timer__label timer__label_desk-slider">м.</span>
                </div>
            </div>
        </div>
        <div class="actions">
            <a href="/gamedemo?gameid=1041" class="action part">Участвовать</a>
            <a href="/resultsGame?gAlias=bet_sz_820" class="action archive">Архив</a>
        </div>
        <div class="result">
            <h3 class="result-title">
                Результат:
            </h3>
            <div class="result-string js-result await">
                <div class="loader-element">
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                </div>
            </div>
        </div>
    </div>
</section>
<section data-request-id="2" class="section game 420"
    style="--game-color: #dd5014; --background: url('https://static.sz.kz/landings/visualizer/420.svg')" id="ftw">
    <img src="<#SelfURL>/picture?file=402" alt="4/20" class="game-logo">
    <div class="section-content">
        <h2 class="visually-hidden">
            4/20
        </h2>
        <div class="timer js-ftw2" data-timer="true" data-postfix="420">
            <div class="timer__title">
                До тиража:
            </div>
            <div class="timer__body timer__body_desk-slider">
                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider days-420">00</span>
                    <span class="timer__label timer__label_desk-slider">д.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider hours-420">00</span>
                    <span class="timer__label timer__label_desk-slider">ч.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider minutes-420">00</span>
                    <span class="timer__label timer__label_desk-slider">м.</span>
                </div>
            </div>
        </div>
        <div class="actions">
            <a href="/gamedemo?gameid=1042" class="action part">Участвовать</a>
            <a href="/resultsGame?gAlias=bet_sz_420" class="action archive">Архив</a>
        </div>
        <div class="result">
            <h3 class="result-title">
                Результат:
            </h3>
            <div class="result-string js-result await">
                <div class="loader-element">
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                </div>
            </div>
        </div>
    </div>
</section>
<section data-request-id="4" class="section game sl"
    style="--game-color: #bd1566; --background: url('https://static.sz.kz/landings/visualizer/sl.svg')" id="sl">
    <img src="<#SelfURL>/picture?file=630" alt="SuperLoto" class="game-logo">
    <div class="section-content">
        <h2 class="visually-hidden">
            SuperLoto
        </h2>
        <div class="timer js-sl" data-timer="true" data-postfix="sl">
            <div class="timer__title">
                До тиража:
            </div>
            <div class="timer__body timer__body_desk-slider">
                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider days-sl">00</span>
                    <span class="timer__label timer__label_desk-slider">д.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider hours-sl">00</span>
                    <span class="timer__label timer__label_desk-slider">ч.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider minutes-sl">00</span>
                    <span class="timer__label timer__label_desk-slider">м.</span>
                </div>
            </div>
        </div>
        <div class="actions">
            <a href="/gamedemo?gameid=1043" class="action part">Участвовать</a>
            <a href="/resultsGame?gAlias=bet_sz_550" class="action archive">Архив</a>
        </div>
        <div class="result">
            <h3 class="result-title">
                Результат:
            </h3>
            <div class="result-string js-result await">
                <div class="loader-element">
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                </div>
            </div>
        </div>
    </div>
</section>
<section data-request-id="14" class="section game keno2"
    style="--game-color: #004f89; --background: url('https://static.sz.kz/landings/visualizer/keno2.svg')" id="keno2">
    <img src="<#SelfURL>/picture?file=631" alt="Keno2" class="game-logo">
    <div class="section-content">
        <h2 class="visually-hidden">
            Keno2
        </h2>
        <div class="timer js-keno2" data-timer="true" data-postfix="keno2">
            <div class="timer__title">
                До тиража:
            </div>
            <div class="timer__body timer__body_desk-slider">
                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider days-keno2">00</span>
                    <span class="timer__label timer__label_desk-slider">д.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider hours-keno2">00</span>
                    <span class="timer__label timer__label_desk-slider">ч.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider minutes-keno2">00</span>
                    <span class="timer__label timer__label_desk-slider">м.</span>
                </div>
            </div>
        </div>
        <div class="actions">
            <a href="/gamedemo?gameid=1083" class="action part">Участвовать</a>
            <a href="/resultsGame?gAlias=bet_sz_keno2" class="action archive">Архив</a>
        </div>
        <div class="result">
            <h3 class="result-title">
                Результат:
            </h3>
            <div class="result-string js-result await">
                <div class="loader-element">
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                </div>
            </div>
        </div>
    </div>
</section>
<section data-request-id="12" class="section game keno"
    style="--game-color: #5199f1; --background: url('https://static.sz.kz/landings/visualizer/keno.svg')" id="keno">
    <img src="<#SelfURL>/picture?file=109" alt="Keno" class="game-logo">
    <div class="section-content">
        <h2 class="visually-hidden">
            Keno
        </h2>
        <div class="timer js-keno" data-timer="true" data-postfix="keno">
            <div class="timer__title">
                До тиража:
            </div>
            <div class="timer__body timer__body_desk-slider">
                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider days-keno">00</span>
                    <span class="timer__label timer__label_desk-slider">д.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider hours-keno">00</span>
                    <span class="timer__label timer__label_desk-slider">ч.</span>
                </div>

                <div class="timer__section">
                    <span class="timer__item timer__item timer__item_desk-slider minutes-keno">00</span>
                    <span class="timer__label timer__label_desk-slider">м.</span>
                </div>
            </div>
        </div>
        <div class="actions">
            <a href="/gamedemo?gameid=1080" class="action part">Участвовать</a>
            <a href="/resultsGame?gAlias=bet_sz_keno" class="action archive">Архив</a>
        </div>
        <div class="result">
            <h3 class="result-title">
                Результат:
            </h3>
            <div class="result-string js-result await">
                <div class="loader-element">
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                    <span class="loader-item">?</span>
                </div>
            </div>
        </div>
    </div>
</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.1/gsap.min.js"></script>
<script>
    const apiUrl = 'https://module.sz.kz/games';
    const merchantId = 'DrawsVisualizer';
    const apiKey = '646a0b91e50c8fec91b7d82794cb5134646a0b91e50c8fec91b7d';

    const gameMapping = {
        1: { name: '8/20', gameId: 1, drawNumber: 1, sectionId: "eghtw", },
        2: { name: '4/20', gameId: 2, drawNumber: 1, sectionId: "ftw", fields: 2, field1: 4, },
        4: { name: 'SuperLoto', gameId: 4, drawNumber: 1, sectionId: "sl", fields: 2, field1: 5, },
        102: { name: 'KENO', gameId: 12, drawNumber: 1, sectionId: "keno", },
        103: { name: '777', gameId: 14, drawNumber: 1, sectionId: "thsev" },
        105: { name: 'KENO2', gameId: 13, drawNumber: 1, sectionId: "keno2" },
    };
    let times = ["10:00", "14:56", "19:00", "20:00", "22:00"];
    // 777 = thsev, 420 = ftw, 820 = eghtw, super loto = sl
    let config = {
        "10:00": [
            gameMapping[103],
        ],
        "14:56": [
            gameMapping[105],
        ],
        "19:00": [
            gameMapping[105],
            gameMapping[4]
        ],
        "20:00": [
            gameMapping[2]
        ],
        "22:00": [
            gameMapping[102],
            gameMapping[103]
        ]
    };


    const body = JSON.stringify({ app_id: 3 });
    const timestamp = Math.floor(Date.now() / 1000);
    const sign = CryptoJS.HmacSHA1(body + timestamp, apiKey).toString();

    const headers = {
        'Content-Type': 'application/json',
        'X-Merchant-Id': merchantId,
        'X-Timestamp': timestamp,
        'X-Sign': sign
    };

    async function fetchLotteryData() {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: body
            });
            const data = await response.json();

            console.log('Полученные данные из API:', data);

            updateDrawNumbers(data);
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
        }
    }

    function updateDrawNumbers(data) {
        // Объект для хранения тиражей с минимальным номером для каждой игры
        const minDrawNumbers = {};

        data.forEach(game => {
            if (!minDrawNumbers[game.game_id] || game.draw_number < minDrawNumbers[game.game_id].draw_number) {
                minDrawNumbers[game.game_id] = game;
            }
        });

        // Преобразуем объект обратно в массив и сортируем по времени тиража (чем ближе, тем выше)
        const filteredData = Object.values(minDrawNumbers).sort((a, b) => a.draw_date - b.draw_date);

        filteredData.forEach(game => {
            const gameInfo = gameMapping[game.game_id];
            if (gameInfo) {
                gameMapping[game.game_id]['drawNumber'] = game.draw_number;
            }
        });
        checkTime();
        setInterval(checkTime, 60000);
    }


    function checkTime() {
        let now = new Date();
        let currentTime = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
        console.log(currentTime);
        if (times.includes(currentTime)) {
            config[currentTime].forEach((item) => { new DataUpdater(item) })
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        fetchLotteryData();
    })

    class DataUpdater {
        constructor(config) {
            this.animationDelay = .5;
            this.base =
                "https://module.sz.kz/drawwinnumbers?game_id=_&draw_number=_";
            this.init(config);
        }

        init(config) {
            let { gameId, drawNumber, sectionId } = config;
            console.log('got data from config', gameId, drawNumber, sectionId)
            if (config.hasOwnProperty('fields')) {
                console.log('has two fields');
                this.field1 = config['field1'];
            }

            this.link = this.base
                .replace(/(?<=game_id=)_/, gameId)
                .replace(/(?<=draw_number=)_/, drawNumber-1);

            console.log('will be fetching', this.link);
            this.resultParent = document.querySelector(`#${sectionId} .js-result`);

            console.log('results will be here', this.resultParent);
            this.fetchDrawResults(this.link, this.onError.bind(this), this.onSuccess.bind(this), this.fetchDrawResults.bind(this));
        }

        messages = {
            fail: " Деректерді ала-алмадық "
        };

        onSuccess(data) {
            console.log(data);
            let numbers = data['winNumberArray'];

            let commonFragment = document.createDocumentFragment();
            let field = document.createElement('div');
            field.classList.add('field');

            numbers.forEach((number, index) => {
                if (this.field1 && index == this.field1) {
                    console.log('break at', this.field1);
                    field.insertAdjacentHTML('afterbegin', '<h3 class="field-title">Поле 1</h3>')
                    commonFragment.append(field);
                    field = document.createElement('div');
                    field.classList.add('field');
                    field.insertAdjacentHTML('afterbegin', '<h3 class="field-title">Поле 2</h3>')
                }

                let item = document.createElement('span');
                item.classList.add('result-item');
                item.textContent = number;
                item.style.setProperty('--del', `${index * this.animationDelay}s`);
                field.append(item);
            })
            commonFragment.append(field);
            this.resultParent.classList.remove('await');
            this.resultParent.append(commonFragment);
        }

        onError(error) {
            this.resultParent.classList.remove("await");
            this.resultParent.innerHTML = `<p class="result-error">${error}</p>`;
        }

        async fetchDrawResults(link, onError, onSuccess, retry, attempt = 1) {
            try {
                console.log("Перед задержкой...");
                console.log("Прошло 2 секунды!");
                console.log(`Попытка ${attempt}: ${link}`);

                const response = await fetch(link);

                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }

                const result = await response.json();

                if (result && result.winNumberArray) {
                    console.log('Успешно получены номера');
                    console.log(onSuccess);
                    onSuccess(result);
                } else {
                    throw new Error(`winNumberArray отсутствует или пуст`);
                }
            } catch (error) {
                console.error(`Ошибка при запросе результатов ${link}:`, error.message);

                if (attempt < 3) {
                    console.log(`Повторная попытка через 3 секунды...`);
                    setTimeout(() => {
                        retry(link, onError, onSuccess, retry, attempt++);
                    }, 3000);
                } else {
                    onError(error);
                    console.error(`Не удалось получить данные ${link} после 3 попыток.`);
                }
            }
        }
    }
</script>